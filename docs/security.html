<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Security · Microkubes</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;The security of the Microkubes platform is implemented at microservice level. Our integrated user management ensures integrity of data by using OAuth2, JWT and SAML for user authentication and authorization. It increases security by eliminating the risk of passwords theft or reuse.The platform provides the fine-grained access control to each object in Microkubes. An ACL specifies which users or system processes are granted access to objects, as well as what operations are allowed on given objects. Each entry in a typical ACL specifies a subject and an operation. This all comes out of the box with Microkubes platform.&lt;/p&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Security · Microkubes"/><meta property="og:type" content="website"/><meta property="og:url" content="https://www.microkubes.com/index.html"/><meta property="og:description" content="&lt;p&gt;The security of the Microkubes platform is implemented at microservice level. Our integrated user management ensures integrity of data by using OAuth2, JWT and SAML for user authentication and authorization. It increases security by eliminating the risk of passwords theft or reuse.The platform provides the fine-grained access control to each object in Microkubes. An ACL specifies which users or system processes are granted access to objects, as well as what operations are allowed on given objects. Each entry in a typical ACL specifies a subject and an operation. This all comes out of the box with Microkubes platform.&lt;/p&gt;
"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="stylesheet" href="https://use.typekit.net/eaz5jri.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/css/main.css"/></head><body class="sideNavVisible"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/microkubes-logo.svg" alt="Microkubes"/><h2 class="headerTitleWithLogo">Microkubes</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/installation-and-setup.html" target="_self">Docs</a></li><li class=""><a href="/help.html" target="_self">Support</a></li><li class=""><a href="/about.html" target="_self">About</a></li><li class=""><a href="https://github.com/Microkubes/microkubes/releases" target="_self">Download</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>Microkubes Manual</span></h2></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Get Started with Microkubes</h3><ul><li class="navListItem"><a class="navItem" href="/docs/installation-and-setup.html">Get Started with Microkubes</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Microkubes Manual</h3><ul><li class="navListItem"><a class="navItem" href="/docs/introduction.html">Introduction</a></li><li class="navListItem"><a class="navItem" href="/docs/installation.html">Installation</a></li><li class="navListItem"><a class="navItem" href="/docs/external-services.html">External Services</a></li><li class="navListItem"><a class="navItem" href="/docs/configuration.html">Configuration</a></li><li class="navListItem"><a class="navItem" href="/docs/self-registration.html">Self Registration on Kong</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/security.html">Security</a></li><li class="navListItem"><a class="navItem" href="/docs/backends.html">Backends</a></li><li class="navListItem"><a class="navItem" href="/docs/deployments.html">Deployments</a></li><li class="navListItem"><a class="navItem" href="/docs/ci-cd.html">CI, CD, Code Quality</a></li></ul></div></div></section></div><script>
            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Security</h1></header><article><div><span><p>The security of the Microkubes platform is implemented at microservice level. Our integrated user management ensures integrity of data by using OAuth2, JWT and SAML for user authentication and authorization. It increases security by eliminating the risk of passwords theft or reuse.The platform provides the fine-grained access control to each object in Microkubes. An ACL specifies which users or system processes are granted access to objects, as well as what operations are allowed on given objects. Each entry in a typical ACL specifies a subject and an operation. This all comes out of the box with Microkubes platform.</p>
<p>Until now we have security support for <a href="http://flask.pocoo.org/">Flask</a>(Python) and <a href="https://goa.design/">Goa Design</a>(Golang)  approaches for building microservices.</p>
<h1><a class="anchor" aria-hidden="true" id="golang-package"></a><a href="#golang-package" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Golang package</h1>
<p>This <a href="https://github.com/Microkubes/microservice-security">microservice-security</a> contains functions that are commonly used by all microservices for setting up the security. Also exposes functions to set up different security mechanisms for securing the microservices.</p>
<p>The security library offers golang API for setting up security based on yor needs. It comes with couple of security providers out-of-the-box:</p>
<ul>
<li>JWT provider - can decode and validate JWTs generated by Microkubes <a href="https://github.com/Microkubes/jwt-issuer">JWT Issuer</a> service</li>
<li>OAuth2 provider  -can decode and validate OAuth2 tokens generated by the <a href="https://github.com/Microkubes/authorization-server">OAuth2 Authorization Serve</a> in Microkubes.</li>
<li>SAML service provider  - can decode and validate JWTs tokens generated by the <a href="https://github.com/Microkubes/identity-provider">Identity Provider</a> in Microkubes. It adds endpoint to each microservice which parse SAML response from Identity Provider and sends microservice metadata to Identity Provider</li>
<li>ACL middleware -  provides access control lists based authorization for the microservices.</li>
</ul>
<p>There are two important packages:</p>
<ul>
<li><strong>auth</strong> - defines the standard Auth object and offers functions for manipulating the request context for setting/getting the Auth object.</li>
<li><strong>chain</strong> - defines the SecurityChain and function for creating new security middleware and registering it with the security chain.</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="manipulating-the-security-auth"></a><a href="#manipulating-the-security-auth" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Manipulating the security Auth</h2>
<p>Auth object can be manipulated in the request context with helpers of the auth package. The package exposes function for checking, setting and getting the Auth object from the context.</p>
<p>To get the current Auth object from the context, you can use auth.GetAuth(context.Context) helper.</p>
<pre><code class="hljs css language-go">authObj := auth.GetAuth(ctx)

<span class="hljs-keyword">if</span> authObj == <span class="hljs-literal">nil</span> {
  <span class="hljs-comment">// The context contains no Auth</span>
}
</code></pre>
<p>In the Goa controllers you can use Auth Context you get the user's information:</p>
<pre><code class="hljs css language-go">    <span class="hljs-keyword">if</span> !auth.HasAuth(ctx.Context) {
        <span class="hljs-keyword">return</span> ctx.InternalServerError(goa.ErrBadRequest(<span class="hljs-string">"no-auth"</span>))
    }

    userID := auth.GetAuth(ctx.Context).UserID
    roles := auth.GetAuth(ctx.Context).Roles

    ...
</code></pre>
<p>The auth context stores the Authorization and Authentication data for a particular user/client:</p>
<ul>
<li><strong>UserID</strong> - ID of the authenticated user</li>
<li><strong>Username</strong> - The email of the authenticated user</li>
<li><strong>Roles</strong> - Roles is the list of roles that the user has claimed and have been authorized by the system.</li>
<li><strong>Organizations</strong> - Organizations is the list of organizations that the user belongs to. This is a list of authorized ogranization based on the security claim.</li>
<li><strong>Namespaces</strong> - Namespaces is the list of namespaces that this user belongs to.</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="security-chain"></a><a href="#security-chain" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Security Chain</h2>
<p>SecurityChain is a standard chain of processing of the incoming http request. It is intended to be
used as a middleware in Goa infrastructure (although it can execute by its own using the standard http Handlers by Go).</p>
<p>SecurityChain is an interface residing in the <code>chain</code> package. This package also provides other helper functions
related to creating the chain, wrapping it in goa.Midlleware or wrapping a Goa middleware in the chain itself.</p>
<p>The chain is composed of a list of middleware functions of type <code>chain.SecurityChainMiddleware</code>.
The signature of this function is:</p>
<pre><code class="hljs css language-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(context.Context, http.ResponseWriter, *http.Request)</span> <span class="hljs-params">(context.Context, http.ResponseWriter, error)</span>
</span></code></pre>
<p>The chain executes the middleware functions in the order they are registered. The input context and ResponseWriter for
each middleware is the output of the previous middleware.
The resulting context, ResponseWriter and Request are returned back by the <code>SecurityChain.Execute(...)</code> method.</p>
<h2><a class="anchor" aria-hidden="true" id="setting-up-a-security-for-a-microservice"></a><a href="#setting-up-a-security-for-a-microservice" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setting up a security for a microservice</h2>
<p>The easier way to set up a security is to use the <code>flow</code> package and the helper <code>flow.NewSecurityFromConfig()</code>.</p>
<p>In the microservice main file, you first need to load the microservice configuration.
The pass the configuration to the helper and create new SecurityChain.</p>
<p>Finally you need to add the security chain as a middleware to the service itself.</p>
<pre><code class="hljs css language-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{

    gatewayAdminURL, configFile := loadGatewaySettings()

    <span class="hljs-comment">// 1. Load the configuration</span>
    serviceConfig, err := config.LoadConfig(configFile)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        service.LogError(<span class="hljs-string">"config"</span>, <span class="hljs-string">"err"</span>, err)
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 2. Create a security chain</span>
    securityChain, cleanup, err := flow.NewSecurityFromConfig(conf)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    <span class="hljs-comment">// There was a problem setting up the security</span>
        service.LogError(<span class="hljs-string">"config"</span>, <span class="hljs-string">"err"</span>, err)
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">defer</span> cleanup()

    <span class="hljs-comment">// ... Goa service and controllers setup</span>

    <span class="hljs-comment">// 3. Finally add the security chain to the service as a middleware.</span>
    service.Use(chain.AsGoaMiddleware(securityChain))
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="security-configuration"></a><a href="#security-configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Security configuration</h2>
<p>The whole configuration for the security chain is read from config file. The service that has set up security from config should have proper configuration for each type.</p>
<p>The package looking for the security property in the configuration. It contains settings for all security types including ACL policies. If some type is ommited then that type of security will not be set. If security property is ommited from config file then service will not have security set.</p>
<p>The structure of security configuration is pretty simple. Example:</p>
<pre><code class="hljs">...

<span class="hljs-string">"security"</span>: {
    <span class="hljs-string">"keysDir"</span>: <span class="hljs-string">"/run/secrets"</span>,
    <span class="hljs-string">"ignorePatterns"</span>: [
      <span class="hljs-string">"/users/verify"</span>
    ],
    <span class="hljs-string">"jwt"</span>: {
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"JWTSecurity"</span>,
      <span class="hljs-string">"description"</span>: <span class="hljs-string">"JWT security middleware"</span>,
      <span class="hljs-string">"tokenUrl"</span>: <span class="hljs-string">"http://kong:8000/jwt"</span>
    },
    <span class="hljs-string">"saml"</span>: {
      <span class="hljs-string">"certFile"</span>: <span class="hljs-string">"/run/secrets/service.cert"</span>,
      <span class="hljs-string">"keyFile"</span>: <span class="hljs-string">"/run/secrets/service.key"</span>,
      <span class="hljs-string">"identityProviderUrl"</span>: <span class="hljs-string">"http://kong:8000/saml/idp"</span>,
      <span class="hljs-string">"userServiceUrl"</span>: <span class="hljs-string">"http://kong:8000/users"</span>,
      <span class="hljs-string">"registrationServiceUrl"</span>: <span class="hljs-string">"http://kong:8000/users/register"</span>,
      <span class="hljs-string">"rootURL"</span>: <span class="hljs-string">"http://localhost:8000/users"</span>
    },
    <span class="hljs-string">"oauth2"</span>: {
      <span class="hljs-string">"description"</span>: <span class="hljs-string">"OAuth2 security middleware"</span>,
      <span class="hljs-string">"tokenUrl"</span>: <span class="hljs-string">"https://kong:8000/oauth2/token"</span>,
      <span class="hljs-string">"authorizeUrl"</span>: <span class="hljs-string">"https://kong:8000/oauth2/authorize"</span>
    },
    <span class="hljs-string">"acl"</span>: {
      <span class="hljs-string">"policies"</span>: [
        {
          <span class="hljs-string">"id"</span>: <span class="hljs-string">"users-allow-admin-access"</span>,
          <span class="hljs-string">"description"</span>: <span class="hljs-string">"Allows access to everything to an admin user"</span>,
          <span class="hljs-string">"resources"</span>: [
            <span class="hljs-string">"&lt;.+&gt;"</span>
          ],
          <span class="hljs-string">"actions"</span>: [
            <span class="hljs-string">"api:read"</span>,
            <span class="hljs-string">"api:write"</span>
          ],
          <span class="hljs-string">"effect"</span>: <span class="hljs-string">"allow"</span>,
          <span class="hljs-string">"subjects"</span>: [
            <span class="hljs-string">"&lt;.+&gt;"</span>
          ],
          <span class="hljs-string">"conditions"</span>: {
            <span class="hljs-string">"roles"</span>: {
              <span class="hljs-string">"type"</span>: <span class="hljs-string">"RolesCondition"</span>,
              <span class="hljs-string">"options"</span>: {
                <span class="hljs-string">"values"</span>: [
                  <span class="hljs-string">"admin"</span>,
                  <span class="hljs-string">"system"</span>
                ]
              }
            }
          }
        },
        {
          <span class="hljs-string">"id"</span>: <span class="hljs-string">"users-allow-read-access"</span>,
          <span class="hljs-string">"description"</span>: <span class="hljs-string">"Allows access to user's own profile"</span>,
          <span class="hljs-string">"resources"</span>: [
            <span class="hljs-string">"/users/me"</span>
          ],
          <span class="hljs-string">"actions"</span>: [
            <span class="hljs-string">"api:read"</span>
          ],
          <span class="hljs-string">"effect"</span>: <span class="hljs-string">"allow"</span>,
          <span class="hljs-string">"subjects"</span>: [
            <span class="hljs-string">"&lt;.+&gt;"</span>
          ],
          <span class="hljs-string">"conditions"</span>: {
            <span class="hljs-string">"roles"</span>: {
              <span class="hljs-string">"type"</span>: <span class="hljs-string">"RolesCondition"</span>,
              <span class="hljs-string">"options"</span>: {
                <span class="hljs-string">"values"</span>: [
                  <span class="hljs-string">"user"</span>
                ]
              }
            }
          }
        },
        {
          <span class="hljs-string">"id"</span>: <span class="hljs-string">"read-swagger"</span>,
          <span class="hljs-string">"description"</span>: <span class="hljs-string">"Allows to service swagger."</span>,
          <span class="hljs-string">"resources"</span>: [
            <span class="hljs-string">"/swagger&lt;.+&gt;"</span>
          ],
          <span class="hljs-string">"actions"</span>: [
            <span class="hljs-string">"api:read"</span>
          ],
          <span class="hljs-string">"effect"</span>: <span class="hljs-string">"allow"</span>,
          <span class="hljs-string">"subjects"</span>: [
            <span class="hljs-string">"&lt;.+&gt;"</span>
          ]
        }
      ]
    }
  }

...
</code></pre>
<p>Configuration properties:</p>
<ul>
<li><strong>keysDir</strong> - is a directory containing the platfrom private/public keys</li>
<li><strong>ignorePatterns</strong> - means ignore security for these patterns</li>
<li><strong>jwt</strong> - contains configuration properties for JWT security.</li>
<li><strong>saml</strong> - contains configuration properties for SAML security.</li>
<li><strong>oauth2</strong> - contains configuration properties for OAuth2 security.</li>
<li><strong>acl</strong> - contains ACLs policies</li>
</ul>
<p><strong>More details</strong> for internal implementation of Microkubes's security can be found in the <a href="https://github.com/Microkubes/microservice-security">package</a>.</p>
<h1><a class="anchor" aria-hidden="true" id="python-library"></a><a href="#python-library" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Python Library</h1>
<p><a href="https://github.com/Microkubes/microkubes-python">microkubes-python</a> provides tools for implementing security in your services that works with the
security infrastructure provided by Microkubes.</p>
<p>The security library offers python API for setting up security based on yor needs. It comes with
couple of security providers out-of-the-box:</p>
<ul>
<li>JWT provider - can decode and validate JWTs generated by Microkubes <code>jwt-issuer</code> service</li>
<li>OAuth2 provider  -can decode and validate OAuth2 tokens generated by the OAuth2 Authorization Server in Microkubes.</li>
</ul>
<p>The security is configured as a chain of providers, so you can have more than one type on any endpoint in your
service.</p>
<p>The main entrypoint for this is the <code>SecurityChain</code>. When a new request is made by the client, the <code>SecurityChain</code>
passes it to every provider in the chain. Every provider attempts to authenticate and authorize the request.
If some of the providers is successful, then <code>Auth</code> object is generated and set i the <code>SecurityContext</code>.</p>
<p>An example of setting up security chain:</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">from</span> microkubes.security <span class="hljs-keyword">import</span> (SecurityChain,
                                 ThreadLocalSecurityContext,
                                 JWTSProvider,
                                 is_authenticated_provider,
                                 KeyStore)

store = KeyStore(dir_path=<span class="hljs-string">'./keys'</span>)  <span class="hljs-comment"># we need key store with the RSA keys so we can validate the JWT signature</span>
context = ThreadLocalSecurityContext()  <span class="hljs-comment"># Keeps the Auth in thread-local, which is fine for tests, but should be avoided for production</span>

chain = (SecurityChain(context).
         provider(JWTSecurityProvider(key_store=store)).  <span class="hljs-comment"># Security chain with JWT auth</span>
         provider(is_authenticated_provider))  <span class="hljs-comment"># check if the request has been authenticated</span>


<span class="hljs-comment"># assuming we receive an HTTP request, the processing of the request can be done like this:</span>
    <span class="hljs-comment"># try:</span>
    <span class="hljs-comment">#     chain.execute(context, request, response)</span>
    <span class="hljs-comment"># except SecurityException serr:</span>
    <span class="hljs-comment">#     response.status_code = serr.status_code</span>
    <span class="hljs-comment">#     response.write_json({"code": serr.status_code, "message": str(serr)})</span>


<span class="hljs-comment"># then we can access the context to get the Auth object:</span>

auth = context.get_auth()

</code></pre>
<h2><a class="anchor" aria-hidden="true" id="security-with-flask-services"></a><a href="#security-with-flask-services" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Security with Flask services</h2>
<p>You can secure your Flask services by using the convinience security builder for Flask.
You need to create new <code>Security</code> and then use <code>Security.secured</code> decorator on your endpoints.</p>
<p>By using the example in Flask above, we can secure the action by setting up a full security chain:</p>
<pre><code class="hljs css language-python">
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask
<span class="hljs-keyword">from</span> microkubes.gateway <span class="hljs-keyword">import</span> KongGatewayRegistrator
<span class="hljs-keyword">from</span> microkubes.security <span class="hljs-keyword">import</span> FlaskSecurity


app = Flask(__name__)
registrator = KongGatewayRegistrator(os.environ.get(<span class="hljs-string">"API_GATEWAY_URL"</span>, <span class="hljs-string">"http://localhost:8001"</span>))  <span class="hljs-comment"># Use the Kong registrator for Microkubes</span>

<span class="hljs-comment"># set up a security chain</span>
sec = (FlaskSecurity().
        keys_dir(<span class="hljs-string">"./keys"</span>).   <span class="hljs-comment"># set up a key-store that has at least the public keys from the platform</span>
        jwt().                <span class="hljs-comment"># Add JWT support</span>
        oauth2().             <span class="hljs-comment"># Add OAuth2 support</span>
        build())              <span class="hljs-comment"># Build the security for Flask</span>




<span class="hljs-comment"># Self-registration on the API Gateway must be the first thing we do when running this service.</span>
<span class="hljs-comment"># If the registration fails, then the whole service must terminate.</span>
registrator.register(name=<span class="hljs-string">"hello-service"</span>,                  <span class="hljs-comment"># the service name.</span>
                     paths=[<span class="hljs-string">"/hello"</span>],                      <span class="hljs-comment"># URL pattern that Kong will use to redirect requests to out service</span>
                     host=<span class="hljs-string">"hello-service.services.consul"</span>,  <span class="hljs-comment"># The hostname of the service.</span>
                     port=<span class="hljs-number">5000</span>)                             <span class="hljs-comment"># Flask default port. When redirecting, Kong will call us on this port.</span>


<span class="hljs-meta">@app.route("/hello")</span>
<span class="hljs-meta">@sec.secured   # this action is now secure</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hello</span><span class="hljs-params">()</span>:</span>
    auth = sec.context.get_auth()  <span class="hljs-comment"># get the Auth from the security context</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello %s from Flask service on Microkubes"</span> % auth.username


</code></pre>
<p><strong>More details</strong> for internal implementation of Microkubes's security can be found in the <a href="https://github.com/Microkubes/microkubes-python">library</a>.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/self-registration.html"><span class="arrow-prev">← </span><span>Self Registration on Kong</span></a><a class="docs-next button" href="/docs/backends.html"><span>Backends</span><span class="arrow-next"> →</span></a></div></div></div></div><footer class="nav-footer" id="footer"><section class="sitemap"><div><h5>Docs</h5><a href="/docs/en/installation-and-setup.html">Getting Started</a><a href="/docs/en/introduction.html">Microkubes Manual</a></div><div><h5>Community</h5><a href="http://stackoverflow.com/questions/tagged/microkubes" target="_blank">Stack Overflow</a></div><div><h5>Social</h5><a class="github-button" href="https://github.com/Microkubes/microkubes" data-icon="octicon-star" data-count-href="/microkubes/microkubes/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><div class="social"><a href="https://twitter.com/Microkubes" class="twitter-follow-button">Follow @Microkubes</a></div></div></section><section class="copyright">Copyright © 2018 <a href="https://www.keitaro.com/">Keitaro Inc.</a></section></footer></div><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script></body></html>