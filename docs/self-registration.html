<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Self Registration on Kong · Microkubes</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;Microkubes has its own &lt;a href=&quot;https://github.com/Microkubes/microservice-tools/tree/master/gateway&quot;&gt;Golang Package&lt;/a&gt; and &lt;a href=&quot;https://github.com/Microkubes/microkubes-python&quot;&gt;Python library&lt;/a&gt; for self registration on Kong. They provide the basic functionality of registering/unregistration for your own service to the API Gateway&lt;/p&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Self Registration on Kong · Microkubes"/><meta property="og:type" content="website"/><meta property="og:url" content="https://www.microkubes.com/index.html"/><meta property="og:description" content="&lt;p&gt;Microkubes has its own &lt;a href=&quot;https://github.com/Microkubes/microservice-tools/tree/master/gateway&quot;&gt;Golang Package&lt;/a&gt; and &lt;a href=&quot;https://github.com/Microkubes/microkubes-python&quot;&gt;Python library&lt;/a&gt; for self registration on Kong. They provide the basic functionality of registering/unregistration for your own service to the API Gateway&lt;/p&gt;
"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="stylesheet" href="https://use.typekit.net/eaz5jri.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/microkubes-logo.svg" alt="Microkubes"/><h2 class="headerTitleWithLogo">Microkubes</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/installation-and-setup.html" target="_self">Docs</a></li><li class=""><a href="/help.html" target="_self">Support</a></li><li class=""><a href="/about.html" target="_self">About</a></li><li class=""><a href="https://github.com/Microkubes/microkubes/releases" target="_self">Download</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>Microkubes Manual</span></h2></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Get Started with Microkubes</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/installation-and-setup.html">Get Started with Microkubes</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Microkubes Manual</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/introduction.html">Introduction</a></li><li class="navListItem"><a class="navItem" href="/docs/installation.html">Installation</a></li><li class="navListItem"><a class="navItem" href="/docs/external-services.html">External Services</a></li><li class="navListItem"><a class="navItem" href="/docs/configuration.html">Configuration</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/self-registration.html">Self Registration on Kong</a></li><li class="navListItem"><a class="navItem" href="/docs/security.html">Security</a></li><li class="navListItem"><a class="navItem" href="/docs/backends.html">Backends</a></li><li class="navListItem"><a class="navItem" href="/docs/deployments.html">Deployments</a></li><li class="navListItem"><a class="navItem" href="/docs/ci-cd.html">CI, CD, Code Quality</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Self Registration on Kong</h1></header><article><div><span><p>Microkubes has its own <a href="https://github.com/Microkubes/microservice-tools/tree/master/gateway">Golang Package</a> and <a href="https://github.com/Microkubes/microkubes-python">Python library</a> for self registration on Kong. They provide the basic functionality of registering/unregistration for your own service to the API Gateway</p>
<h2><a class="anchor" aria-hidden="true" id="python-library"></a><a href="#python-library" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Python Library</h2>
<p>The library provides the basic function of registering your own service with the API Gateway. The tools are provided in package <code>microkubes.gateway</code>.</p>
<p>To register your service on a gateway, you need to use a <code>Registrator</code>. <code>microkubes-python</code> comes with support for Kong Gateway.</p>
<p>Example:</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">from</span> microkubes.gateway <span class="hljs-keyword">import</span> KongGatewayRegistrator


registrator = KongGatewayRegistrator(os.environ.get(<span class="hljs-string">"API_GATEWAY_URL"</span>, <span class="hljs-string">"http://localhost:8001"</span>))  <span class="hljs-comment"># Use the Kong registrator for Microkubes</span>


<span class="hljs-comment"># Self-registration on the API Gateway must be the first thing we do when running this service.</span>
<span class="hljs-comment"># If the registration fails, then the whole service must terminate.</span>
registrator.register(name=<span class="hljs-string">"hello-service"</span>,                  <span class="hljs-comment"># the service name.</span>
                     paths=[<span class="hljs-string">"/hello"</span>],                      <span class="hljs-comment"># URL pattern that Kong will use to redirect requests to out service</span>
                     host=<span class="hljs-string">"hello-service.services.consul"</span>,  <span class="hljs-comment"># The hostname of the service.</span>
                     port=<span class="hljs-number">5000</span>)                             <span class="hljs-comment"># Flask default port. When redirecting, Kong will call us on this port.</span>

</code></pre>
<h2><a class="anchor" aria-hidden="true" id="golang-package"></a><a href="#golang-package" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Golang Package</h2>
<p>The package provides the basic interface for self regstration/unregistration of microservices. It is easy to set up and easy to use. It makes sure that when service goes down it will be unregister, although it is not required.</p>
<p>Example:</p>
<pre><code class="hljs css language-go">
<span class="hljs-keyword">import</span> (
  <span class="hljs-comment">// other imports here</span>

  <span class="hljs-comment">// import the gateway package</span>
  <span class="hljs-string">"github.com/Microkubes/microservice-tools/gateway"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">// load the Gateway URL and the config file path</span>
    gatewayAdminURL, configFile := loadGatewaySettings()

    <span class="hljs-comment">// read the configuration from config file</span>
    serviceConfig, err := config.LoadConfig(configFile)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        service.LogError(<span class="hljs-string">"config"</span>, <span class="hljs-string">"err"</span>, err)
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// creates new gateway.Registration service with the service configuratipn. We pass the default http client here</span>
    registration := gateway.NewKongGateway(gatewayAdminURL, &amp;http.Client{}, serviceConfig.Service)

    <span class="hljs-comment">// at this point we do a self-registration to API Gateway</span>
    err = registration.SelfRegister()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// if there is an error it means we failed to self-register so we panic with error</span>
        <span class="hljs-built_in">panic</span>(err)
    }

    <span class="hljs-comment">// the unregistration is deferred for after main() executes. If we shut down</span>
    <span class="hljs-comment">// the service, it is nice to unregister, although it is not required.</span>
    <span class="hljs-keyword">defer</span> registration.Unregister()

    <span class="hljs-comment">// rest of the code for main goes here</span>
    ...
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">loadGatewaySettings</span><span class="hljs-params">()</span> <span class="hljs-params">(<span class="hljs-keyword">string</span>, <span class="hljs-keyword">string</span>)</span></span> {
    gatewayURL := os.Getenv(<span class="hljs-string">"API_GATEWAY_URL"</span>)
    serviceConfigFile := os.Getenv(<span class="hljs-string">"SERVICE_CONFIG_FILE"</span>)

    <span class="hljs-keyword">if</span> gatewayURL == <span class="hljs-string">""</span> {
        gatewayURL = <span class="hljs-string">"http://localhost:8001"</span>
    }
    <span class="hljs-keyword">if</span> serviceConfigFile == <span class="hljs-string">""</span> {
        serviceConfigFile = <span class="hljs-string">"/run/secrets/microservice_user_config.json"</span>
    }

    <span class="hljs-keyword">return</span> gatewayURL, serviceConfigFile
}
</code></pre>
<p>As you can see from the above example API gateway URL and service config are set through the enviroment variables. If they are not set then default values are used.</p>
<p>The service loads the <code>gateway</code> configuration config file. Here's an example of a JSON configuration file:</p>
<pre><code class="hljs">{
  <span class="hljs-string">"service"</span>: {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"microservice-name"</span>,
    <span class="hljs-string">"port"</span>: <span class="hljs-number">8080</span>,
    <span class="hljs-string">"paths"</span>: [
      <span class="hljs-string">"/service-path"</span>
    ],
    <span class="hljs-string">"virtual_host"</span>: <span class="hljs-string">"microservice-name.service.consul"</span>,
    <span class="hljs-string">"weight"</span>: <span class="hljs-number">10</span>,
    <span class="hljs-string">"slots"</span>: <span class="hljs-number">100</span>
  },
  <span class="hljs-string">"gatewayUrl"</span>: <span class="hljs-string">"http://kong:8000"</span>,
  <span class="hljs-string">"gatewayAdminUrl"</span>: <span class="hljs-string">"http://kong:8001"</span>,

  ...
}
</code></pre>
<p>Configuration properties:</p>
<ul>
<li><strong>name</strong> - <code>&quot;microservice-name&quot;</code> - the name of the service.</li>
<li><strong>port</strong> - <code>8080</code> - port on which the microservice is running.</li>
<li><strong>paths</strong> - <code>/service-path</code> - A list of paths that match this Route</li>
<li><strong>virtual_host</strong> - <code>&quot;microservice-name.services.jormugandr.org&quot;</code> domain name of the service group/cluster.</li>
<li><strong>hosts</strong> - list of valid hosts. Used for proxying and load balancing of the incoming request. You need to have at least the <strong>virtual_host</strong> in the list.</li>
<li><strong>weight</strong> - instance weight - user for load balancing.</li>
<li><strong>slots</strong> - maximal number of service instances.</li>
<li><strong>gatewayUrl</strong> - <code>http://kong:8000</code> - is Gateway proxy URL</li>
<li><strong>gatewayAdminUrl</strong> - <code>gatewayAdminUrl</code> - is Admin Gateway URL</li>
</ul>
<p><strong>Note:</strong> The registration of the service to the gateway should be one of the first things that the service does. On Microkubes, microservices do this check first and terminate if anything goes wrong.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/configuration.html"><span class="arrow-prev">← </span><span>Configuration</span></a><a class="docs-next button" href="/docs/security.html"><span>Security</span><span class="arrow-next"> →</span></a></div></div></div></div><footer class="nav-footer" id="footer"><section class="sitemap"><div><h5>Docs</h5><a href="/docs/installation-and-setup.html">Getting Started</a><a href="/docs/introduction.html">Microkubes Manual</a></div><div><h5>Community</h5><a href="http://stackoverflow.com/questions/tagged/microkubes" target="_blank">Stack Overflow</a></div><div><h5>Social</h5><a class="github-button" href="https://github.com/Microkubes/microkubes" data-icon="octicon-star" data-count-href="/microkubes/microkubes/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><div class="social"><a href="https://twitter.com/Microkubes" class="twitter-follow-button">Follow @Microkubes</a></div></div></section><section class="copyright">Copyright © 2019 <a href="https://www.keitaro.com/">Keitaro Inc.</a></section></footer></div><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script></body></html>